/*
 * BEGIN HEADER
 * c 1999-2003 HUSH COMMUNICATIONS CORP      ALL RIGHTS RESERVED
 * This source code is for review only.  Please contact Hush Communications for
 * licensing terms.  (http://corp.hush.com/contact/)
 * END HEADER
 */

package com.hush.hee.legacy;

import org.bouncycastle.crypto.BlockCipher;
import org.bouncycastle.crypto.CipherParameters;
import org.bouncycastle.crypto.DataLengthException;
import org.bouncycastle.crypto.params.KeyParameter;

/**
 * A class that provides Blowfish key encryption operations,
 * such as encoding data and generating keys.
 * All the algorithms herein are from Applied Cryptography
 * and implement a simplified cryptography interface.
 */
public class LegacyBlowfishEngine implements BlockCipher
{
	private static int[] Pinit;
	private static int[] Sinit;
	private final static String Penc =
		"\u0012\u000f\u006d\u0028\u0044\u0016\u0046\u0008\u0069\u0044\u0063\u0018\u0051\u0038\u0006\u0070\u0039\u0051\u0014\u0040\u0049\u0060\u0044\u0029"
			+ "\u004f\u004c\u003a\u0000\u0041\u003b\u0075\u0018\u0076\u0013\u004d\u0048\u004a\u0014\u0050\u0021\u0073\u000e\u001a\u0001\u001b\u005e\u007c\u0054"
			+ "\u0033\u0033\u0066\u004e\u0048\u0031\u0059\u0040\u0056\n\u0036\u007c\u004b\u0071\u0021\u005d\u001f\u0061\u001a\u005b\u002d\u0055\u000e\t\u000b"
			+ "\u0064\u0042\u006d\u002e\u0066\u0012\u0079\u007d\u0046\u0060";
	private final static String Senc =
		"\u0068\u004c\u0021\u003a\u0034\u0063\u003f\u0035\u0056\u000b\u007f\u0057\u0016\u006f\u0020\u001a\u006f\u006d\u0077\u000e\r\u003f\u005a\u006a\u0013\u001f\u0052\u006b\u0053\u0072\u0020\u0045\u0078\u004b\u000f\u0079\u0049\u0012\u0043\u0019\u0023\u006c\u0072\u0016\u0067\\\u0010\u0001\u0079\u0038\u0050\u0058\u0077\u0070\u002c\u0063\u0034\u0048\u001b\u0007\n\u005d\u001c\u0069\u0052\u0016\u001f\u006a\u001f\u0052\u0026\u003d\u003f\u0003\u0032\u0057\u0024\u003d\u0065\u000e\u005b\u0016\u000e\u0018\u005e\u0035\u0031\u0002\n\u0052\u005d\u0067\u005a\u0052\u0048\u001d\u0061\u0016\u004b\u001b\u002c\u0070\u0061\u0055\u001c\u004a\u005e\u0026\u0000\u004f\u000b\u0051\u0058\u0008\u0065\u0006\u0004\u0017\u0061\u004a\u0020\u005e\u0023\u000b\u0046\u006c\u0071\u006f\u0047\u001e\u003b\u004b\u0003\u0000\u0074\u0018\u0007\u001b\u0013\u0060\u0074\u002e\u0060\u001e\u0045\u000f\u005a\u0071\u002b\u005f\u0003\u003d\u0018\u0052\u0064\u0077\u0045\u003c\u005f\u005a\u002a\u0058\u000b\u0046\u0007\u0019\u002a\u0025\u0079\u006a\u004a\u005a\\\u0051\u002e\u0048\u004c\u0018\u004c\u003e\u0040\u0051\u0000\u0055\u0065\u000e\u002d\"\u0055\u002c\u0021\u0036\u005a\u0033\u000b\u0043\u0020\u0045\u0003\u0068\u0067\u0028\u002a\u0048\u0035\u003d\u0078\u0072\u0074\u0064\u0076\u003e\u0070\u0050\"\u0063\u0037\u006f\u0005\"\u005d\'\n\u005d\u003a\u0006\u0006\u001f\u0036\u0039\u0038\u003e\u000b\u0026\u0070\u0079\u0018\u007a\u005f\u0056\u005d\f\u006d\u0042\u0026\u003d\u0038\u007a\u0019\u0014\u0070\u0012\u0044\u0056\f\u0077\u001d\u0063\u0069\t\u0043\u002d\u0017\u0039\u0057\u0071\u0017\u007e\u0040\u006d\u004c\u0028\u0010\u0064\u006c\u001d\u0040\'\u0019\u007b\u0010\u006a\u0032\u0014\u0043\u0072\u0058\u0060\u002e\u007b\u0010\u0003\u0017\u003e\u0008\u005d\u002e\u007a\u0030\u0057\u002d\u0047\u0038\u0026\u0011\u0040\u005d\u0036\u0028\u006e\u0010\u0023\u0044\u004f\u0050\u001d\u001c\u005a\u0059\u0045\u0007\u005b\u002d\u007f\u001c\u000f\u0068\u0042\u001c\u004b\u0041\u0034\u0024\n\u0049\u0004\u0010\u0001\r\u001c\u0047\u0041\u0015\u001e\u000f\u0066\u006b\u0062\u000e\u0019\u0050\u0042\u007b\u003a\u002d\u0049\u0053\u001c\u0019\u001c\u0030\u006a\u007a\u0038\u0047\u0041\u0054\u0051\u0050\u0034\u005b\u0005\u0021\u003d\u0051\u0016\u0007\u0069\u0065\n\u005a\u0044\u0067\u0023\u0037\u003b\u0061\u0036\u0060\u004d\u0074\u003b\u0072\u002e\u0047\u003f\u0002\u0041\u007d\u007b\u0015"
			+ "\u0026\u0014\u001f\u000b\u0014\u003a\u0039\u0057\u0040\u002e\u0066\u0036\u0029\u0032\u003e\u0041\u0010\u0061\u0068\u0044\u0033\u005d\u0006\f\u0051\u002d\u0079\u007d\u0051\u007b\u0004\u0052\u0070\u0067\u0038\u005a\u007a\u007d\u0060\u0037\u005d\u003b\u0008\u002e\u0004\u0040\u0073\u0020\u0006\u0048\u0049\u007a\u005b\u0002\u006a\u0053\u0013\u005a\u003a\u0053\u0008\u006c\u003f\u003b\u0041\u0043\u003f\u0076\u007d\u0064\u0042\u004d\u0040\u0047\u0053\u003e\u0043\u002e\u0024\u0068\u0002\u0042\u0024\u0046\u006c\u001f\u006a\u0069\u0052\u003e\u001c\u0004\u006c\u000e\u0053\u0039\u0032\u0030\t\u0048\u006d\u0076\u0025\u006a\u001e\u003b\u000f\u0037\u0023\u003d\u0077\u0071\u007f\u004a\u0001\u0055\u0059\u0072\u004c\u001d\u0065\u006d\u004e\u0005\u0074\t\u0040\u0003\u002e\u0058\u001a\u004a\u003e\u006c\u0040\u004f\u0058\u0018\u0045\u0072\u0072\u003d\u0042\f\u005a\u0044\u0046\u001b\u0023\u0076\u006f\u0057\u004f\u004d\u0045\u001d\u0054\u0026\u0039\u0059\u003a\u0067\u0035\u0017\u0031\u005e\u006d\u007e\u0014\u0023\u0079\u0059\u0042\u002a\u002c\u0066\u0020\u0028\u0054\u0025\u003d\u003d\u003d\u0004\u006f\\\u003d\u0000\u0013\u003c\u0033\u0025\u003f\u002c\u0060\u0079\u0020\u000e\u0019\u0017\u0012\u0076\u003c\u0006\u002e\u0050\u0057\"\u0072\u000e\u0040\u007e\u0048\u0016\u005f\u001c\u006e\u003a\u003f\u005e\u006d\u002a\u0079\u0060\u002f\u0023\u0026\u0001\u0048\u0015\u0056\u0050\u0040\u0018\u0064\u0001\u0031\u0064\u0079\u0033\u0067\u0064\u005f\u0077\u006c\u003f\u0023\u0066\u0023\u0054\u005e\u004f\u0063\u0036\u0032\u0011\u003e\u0007\u0047\u0028\u005b\u003f\u007d\u0030\u005a\u0062\u0052\u007a\u0040\u003d\u0048\u0056\u0041\u002a\u002a\u0059\u0048\u007b\u0035\u007d\u003f\u0024\u0038\u003b\u0001\u0026\u0031\u003d\u0052\u0007\u0060\u0006\u007e\u0005\u001e\u002e\u0015\u0077\u003c\u0053\u003e\u0019\u0020\r\u0021\u006a\u0062\u0076\u007c\u002e\u0069\u006d\u0075\u0028\u002a\u0047\u0058\u0050\u007e\u007f\u0070\u0075\u0046\u0039\u004b\r\f\'\u0055\u002e\u0036\u004a\u006c\u004f\u0030\u005d\u0072\u004b\f\u0047\u0007\u007f\u0023\u002e\u006e\u001e\u0001\r\u0000\u0021\u007a\u001e\u0066\u001f\u0052\f\u000e\u0070\u004a\u007e\u002d\u002d\u0042\u006e\u0047\u0026\u005b\u004d\u0014\u007c\u0047\u004d\u005b\u0070\u0045\u0032\u0074\u0051\u0064\u004d\u0071\u0017\u007b\u004b\u0064\u001c\u001d\u006f\u004b\u0035\u0024\u0065\u005f\u0046\u0036\u0017\u006c"
			+ "\u0026\u0041\u0067\u0039\u0018\u006e\u0047\u003c\u0041\u004a\u006d\r\u004e\u0074\u0060\u0007\u0020\u007e\u004f\u003f\u0045\u003f\u0008\u007e\u0069\u0015\u006d\u0076\u0049\u005a\u0074\u0042\u0023\u0018\u0075\u002b\u0031\u0067\u000b\u002e\'\u0055\u0050\u0034\u0011\u006d\u000e\u0042\u005f\u0047\u0012\u0078\u0011\u0063\u0062\u006c\u005f\u000e\u003a\u0065\u0016\u0078\u007f\u005b\u0045\u007b\u0079\u0004\u0045\u0036\u0024\"\u0011\u0038\t\u0024\u0001\u005f\u0000\u0071\u001f\u002d\u002f\u0028\r\u0008\u007e\f\u0039\u0051\u0067\u007c\u0032\u001b\u001d\u0023\u0003\u002d\u0017\u004b\u0064\u0021\u0045\u0078\u001c\u0017\u003b\u007a\u004e\u0052\u006f\u007a\u0016\u0002\u000f\u0068\u003c\u005a\u0006\u0030\u001f\u0035\u0037\u005d\u001d\u0001\u0045\u0033\u0067\u0056\u0067\"\u003c\u0029\u004d\u0052\u0050\u004f\u0070\u003f\"\u003e\u0005\u005d\u0079\u0044\u001d\u0060\u003a\u002a\u006d\u0023\u0032\u0016\u002f\u0068\u004c\u0068\u0004\u0055\u006e\u0005\u0049\u0073\u000e\u0031\u0021\u0004\u0034\u0014\u003b\u0079\u0055\u0052\u0003\u0015\u006f\u0035\u007d\u0021\u0058\u0075\"\u000b\u006b\u007b\u004e\u004d\u0039\u007e\u005e\u0036\u005e\f\u003d\u004f\u0051\u001a\u0006\u0059\u0002\u001b\u0069\u006b\u0043\u0067\u0072\u0024\u0000\u0025\u0007\u000b\u0024\u0007\r\u004d\u003c\"\u0034\u0000\u0017\u0035\u003d\u0063\u0041\u002f\u0012\u0019\u0006\u0069\u005f\u0040\u0013\u0039\u000f\u0015\u002c\u0039\u0008\u0075\u0033\u005f\u0053\u002a\u004f\f\n\u000e\u0013\u0059\u002d\u0014\u006f\u0072\u0003\u0075\u0037\"\u0001\u0039\u0037\u001c\u002c\f\u004c\u0003\u003b\u0018\u0052\\\u007d\u0024\u0023\u0048\f\u005a\t\u0067\u001a\u0029\u0003\u0033\u0023\u004b\u0039\'\u0058\u0052\u0052\u004a\r\u0054\u0020\u0005\u0014\u0069\u0026\u0029\n\u0075\u0041\u0075\u0039\u007e\u0079\u001b\u0063\u0039\u0005\u0036\u0005\u0011\u006d\u0001\u0073\u001d\u0000\u0000\u0045\u0069\u005f\u0035\u002b\u0046\u007d\u0011\u007f\u004a\u002d\u006c\u0035\u004a\u0041\u005d\u0048\u0056\u006c\u0063\u0032\u0048\u003c\u007b\u004f\u0066\u006d\u007f\u001a\u0001\u0025\u006c\u002c\u0015\u002c\u0064\u0029\u006c\u0005\u0055\u006d\u0026\u003f\u000f\u0050\u0042\u0017\u0024\u003c\u0065\u005d\u0005\u0003\u005a\u0049\u0037\u0053\u0043\u0053\u0035\u0059\u004a\u0028\u004d\u005b\u0054\u0012\u002e\u0062\u0006\u0024\u0062\u001d\u0035\u005d\u0026\u0058\u0012\u0034\u007d\u007b"
			+ "\u0076\u0039\u006e\u0030\u002e\u0011\u007e\u006d\u0049\u004d\u006c\u0055\u0023\u000e\u0016\u004c\u0068\u002f\u007f\u002b\u0019\n\u0026\u0066\n\u0063\u001e\u0070\u0046\u0026\u0060\u0015\u0015\u006a\t\u0026\n\u0034\u0005\u0048\u004d\u0001\u0064\f\u000e\u0047\u0063\u007a\u0052\u0031\u001a\u002d\u0050\u0053\u0056\u002b\u002e\u001f\u0064\u006b\u0026\u003e\u0073\u007e\u005a\u0043\u0052\u004e\u0001\u007d\u007e\u0041\u0043\u006a\u004d\u0016\u004e\u001c\u006f\u0001\u0015\u003b\u0041\u0026\u0037\u0024\u0008\u0034\u0011\u0061\u006b\u0013\u0018\u0070\u002e\u004e\u0018\u0004\u001e\u0066\u0017\u0041\u0016\u0043\u002c\u007e\u003e\u005d\u003b\u0079\u0013\u0064\\\u0030\u0014\u0035\u005a\u004e\n\u000b\u0021\u007e\u0035\u0042\u0014\u0054\u000e\u0014\u001a\u006f\u001c\u0029\u0041\u0035\u0025\u0000\u001c\u006e\u003e\u0003\u0061\u0003\u0047\u007e\u007a\\\\\u0047\u001f\u0028\u004e\u0062\\\u002d\u0072\\\u002c\u0007\u002d\u0051\u005f\u0060\u0050\u0006\u0003\u003e\u0001\u0060\u007c\u0008\u0002\u0000\u002c\u007f\u007a\u0070\u0033\u006a\u001a\u001e\u002d\u002e\u004b\u0011\u0016\u0006\u007a\u002c\u0037\u0001\u0012\r\u0077\u0023\u0011\t\u007e\u002f\u004a\u0049\u003f\u006d\u0014\u0019\u0011\u006e\u0032\u0017\u0055\u000e\u0001\u001d\u0039\u003c\u0058\t\u005f\u0005\u005a\u006e\u0032\u0016\u0057\u0031\u0052\u0035\u0073\u006e\u0069\u0075\u0014\u0023\u0005\f\u000f\u0068\u0000\u0061\u006e\u0066\u0023\u000e\u003e\u0052\u001d\u0023\u0064\u000f\u0008\u0071\u004d\u004c\u004e\u007d\u0020\u0071\u003c\u0065\u0000\u005d\u0068\u0023\u0003\u0075\u004c\u0062\u004e\u002a\"\u0067\u0004\u007b\u0036\u0072\u0008\u0037\u0050\u0041\u0050\u001f\u0058\u0014\u0004\u005f\u004b\u0017\u0001\u0014\u0040\u0049\u0017\u003e\u001e\u002a\u0067\u004d\u0041\u0065\u003c\u0057\u0062\u0035\u007d\u0074\u0069\u006e\u001f\u006c\u0064\u0061\u0001\u0005\u004e\u0017\u002e\t\u0037\u0019\u0073\u0079\u0039\u002a\u0012\u0039\u0007\u0065\u0066\u005b\u0044\u0048\u0050\r\u0037\u003c\u0069\u007c\u0013\u001b\u0007\u003d\u0016\u0008\u0071\u0043\u0050\u0011\u005a\u000b\u006f\u0013\u0079\u0055\u0073\u0052\u004b\u003e\u0063\u001d\u0047\u0057\u0030\u0075\u005b\u0042\u0047\u003f\u0026\u0018\u0025\u0006\u0066\u0062\u0019\u0018\u003d\u0017\u003c\u0038\u0018\u0023\u004c\u0042\u005d\u0048\u0023\u003a\u0043\u001d\u004d\u0064\u004c\u0015\u0068\u002c\u0012"
			+ "\u0050\u0053\u0028\u0032\u0053\u0017\u0008\u0051\u0028\u0025\u0000\u0000\u0010\u004c\u0075\u0064\u006e\\\u003b\u007f\u0044\u0078\u0020\u0031\'\u0015\u0030\u001a\u0063\u005f\u002c\u005f\u0008\u0046\u0033\u0030\u0021\u0055\u002d\u0071\u006b\u0068\u0078\u0076\u0059\u0070\"\u0018\u001d\u0056\u0024\u004a\u0028\'\u0065\u000f\u0073\u003b\u0032\u007f\u000f\u006f\u0075\u001e\u005d\u002f\u0065\u0041\u0070\u0054\u0078\u006e\u0043\u0038\u0068\u0057\u0007\u002b\u0052\u006f\u0058\u0061\u0041\u0065\u0070\u0029\u0034\u003e\u0015\u002c\u006e\u0071\u007f\u001c\u0038\u004e\u001e\u0041\u005f\"\u004b\u0017\u0039\u0039\u004c\u0079\u0063\u0050\u007c\u0000\u007d\t\u006b\u0014\u004c\u006c\u0041\u0014\\\u004c\u0064\u005e\u0013\u0041\u0005\u004d\u0055\u0046\n\u0043\u0057\u0029\'\u000b\u0054\u0078\u0052\u007f\u0007\u0045\u0018\u0078\u0014\u002d\u007a\u003c\u005e\u0074\u0075\u001c\u006c\u001d\u0015\u004f\u0023\u0013\u0049\u0018\u001e\u0019\u0061\u001e\u002c\u0005\u0011\u000e\u004e\u0008\u007b\u0044\u0062\u002b\u0037\u002e\u005b\u007e\u0037\u003a\u0058\u0031\u007b\u001b\u0047\u003c\"\u0065\u0034\u0067\u005e\"\u0007\u0031\u003f\u004d\u007a\u0010\f\u0033\u007e\u0028\u0061\u004c\u005b\u005e\u007d\u0079\u0058\u005a\u0052\u0059\u002b\u0002\f\u0015\u0051\u002b\u004c\u0000\u005d\u006c\u0075\u0014\u001f\u005b\u0017\u0065\'\u0032\u0057\u003d\u007b\u002d\u002d\u005b\u0045\u0078\u0020\u0054\u0043\u0036\u0014\n\u0020\u0076\u000b\u0043\u0059\u005d\u0023\u005d\u002c\u0019\u0078\u0054\u0020\u0013\u0066\u002a\u0006\u000e\u005b\u0006\u007b\u0016\u0001\u004d\u001f\u0061\u0075\u0028\u0006\u0063\u0067\u006d\u002e\u0035\u0064\u0041\u0018\u0070\u0051\u000e\u003a\u0059\u0074\u0078\u0017\u004b\u0055\u0037\u0042\u004e\u0076\u0032\r\u003c\u0030\u0018\u0045\u004a\u003c\u0072\u0056\\\u0055\u006c\u005e\u0038\u0023\u0039\u0049\u000b\u000f\u002b\u0063\u001b\u006f\u0043\u0015\u0020\u0011\u005a\u0037\u0016\u002a\u006a\u0076\u0050\u0020\u001a\u000b\u0023\u0011\u0070\u0055\u0034\u0059\u004c\u0033\u006e\u004e\u0057\u0000\u0021\\\u003d\u0073\u0035\u0020\u002c\u0033\u0007\u002f\u0068\u0013\u0019\u002f\u005e\u0032\u007e\u0031\u000f\u002f\u005a\u0047\u0060\u006f\u0008\u004d\u0025\u007c\u0032\u006b\\\u0023\u006d\u0049\u0057\u0062\u0066\u0040\u004a\u0002\u000e\u001a\u0062\u0005\u001c\u003f\u0018\u003f\u0056\u004b\u0037\u005b\u007a\u000b\u0061\u0031"
			+ "\u003a\u004c\u0055\u007e\u0058\u0025\u0014\u0036\"\u0039\u0018\u0073\u0038\u001e\u000f\u007e\u001a\u0061\u0011\u0052\u006c\u006d\u004c\u0015\u006b\u0029\u004b\u0046\u0005\u0024\u003f\u0032\u0048\u0072\u001b\u0037\u0043\t\u0021\u0031\u006b\u0079\u003b\u0066\u004c\u0037\u007f\u0055\u007e\u0014\u003b\u002c\u001e\u0073\u0070\u0078\u0073\u002e\u0052\u0042\u004d\u004f\u0021\u0049\u0037\u0071\u0050\u0042\u0005\u0068\u0050\u0040\u003e\t\u0078\u0008\u005e\u0077\n\u006d\u0023\u0055\u002a\u007d\u002d\u005b\u0031\u001e\u0015\u007d\u0032\u0069\u007d\u0006\u001d\u0005\u0074\u0021\u003b\u006d\u002b\u005d\u0055\u004a\u004f\u001d\u0047\u0028\u001c\u0069\u0004\u000b\u0058\u000f\u001e\u0033\u0068\u0034\u0015\u001b\u0047\u0072\u0012\u0068\u0076\u0051\u0076\u0002\u0062\u0028\u0033\u006c\u002a\u000f\u0049\u0037\r\u0013\u0011\u005f\u0048\u0044\u000e\u0041\u0041\u0063\u006d\u0054\u0037\u0078\u0054\u0049\u0043\u0034\u0072\u006e\u0049\u0012\u001e\t\n\u0005\u0055\u0052\u002b\u0014\u0014\u0012\u005b\u005f\u0040\u0015\u0051\u004a\"\u003a\u0014\u0031\u002c\u002e\u0042\u001c\u0008\u001c\u0000\u002c\u0010\u0051\u0052\u0050\u0031\u002b\u0075\u0075\u0007\u0035\u005f\u0021\u0078\u0046\u003f\u0038\u0018\u0026\u0037\u0017\u0042\u0025\r\u0049\u005f\u0048\u001d\u0032\u007f\u0059\u0071\u0036\u0008\u0047\u003d\u005b\u0073\u003c\u0037\u002c\u0072\u007d\u0067\u0023\u0001\u0001\u0005\u0079\u0029\u0079\u0067\u0039\u0049\u005d\u0026\u0003\u0060\u0010\u0041\u004f\u0061\u0021\u001e\u0074\u003b\u007b\u0005\u002b\u0007\u0033\u0017\u001a\u006a\u002d\u001a\u003d\u002b\n\f\u0003\u0030\u004b\u0020\u0025\u002f\u0079\u0000\u0005\u0072\u005b\u0049\u0072\u0011\u0074\u002e\u0061\u0051\u0026\u0048\'\u0077\u002a\u0067\u0002\u0043\u0043\u0069\u0076\'\u0036\u0073\u006d\u0074\u0062\u0005\u002c\u0023\u001a\u0067\u002f\u0076\u004f\u001e\u001b\u001d\u0006\u0040\u0062\u0071\u0006\u0046\u002b\u0044\u007c\u0038\u006c\u000f\u0025\u000f\u0044\u007b\u0062\u006d\u007f\u0048\u0002\u0053\u0071\u0007\u004f\u000f\u0058\u000f\u0029\u002e\u0037\u000e\u003e\u002b\u006d\u0060\u0075\u005f\u003f\u0024\u007a\u005a\u0034\u0025\u0010\u0014\u0007\u005f\u006c\u004c\u0013\u0007\u0012\u0046\u0049\u0024\u0068\u0041\n\u0048\u001e\u0077\u0030\u000b\u0029\u0077\u005e\u003d\r\u0032\u0076\u0052\u0044\u0000\u0034\u0035\u0001\u0002\u0023\u0044\u0066\u0020\u007a\u001a\u0048\u003b"
			+ "\u003e\u0052\u006e\u0050\u0000\u0018\u0035\u0071\u0071\u0067\u006c\u002e\u004b\u0049\u0008\u0054\u0030\u0050\u0042\u004f\u003a\u002f\u0071\u0038\u0042\u0001\u001b\u0015\u007e\u0007\u0032\u006b\u002c\u0046\u005e\u0070\u007a\u0037\u003a\u0036\u0035\u0000\u005e\u0045\u005f\u006f\u0001\u001e\u0060\u000e\u007b\u0017\u0042\u005f\u0075\u0046\u006e\u0040\u0063\u004b\u0042\u0041\u0012\u006e\u0059\u001e\u0066\u0055\u007e\u004e\u0028\u001d\u0051\u0015\u000f\u0066\u0055\u0072\u0041\u0029\u0051\u0021\u0020\u0078\u0012\u0054\u0060\u0042\u004f\u0050\u0014\u002c\u0043\u0036\u005d\u001b\u0033\u0037\u0076\u0068\u006e\u0005\f\u002d\u003a\u0021\u0052\u0000\u0034\u0003\u0058\n\u0021\u001e\u0043\r\u0077\u0013\u0067\u007f\u0075\u000b\u0051\u0007\u0056\u0063\u0016\u0058\u0067\u0000\f\u007a\u007a\u0035\u0056\u006a\u0056\u0038\u003c\u007c\u0069\u004d\u006b\u007e\u0066\u0039\u0071\u0023\u004c\u0050\r\u0032\u0052\u0008\u0041\u007e\u004f\r\u003b\u001f\u001c\u0016\u0073\u006e\u001c\u0075\u0075\u0033\u0058\u0049\u001d\u000b\u000e\u0072\u003f\u002f\u003a\u002d\u005a\u0018\u002b\t\u0054\u0036\u0031\u0047\u0055\u0063\u004b\u006c\u0047\u0026\u0077\u0069\u0069\u005d\u002d\u0050\u0066\u0026\u0042\u0007\u004f\u0077\u0065\u001e\u0004\u000f\u005f\u006c\u0015\u0075\'\u0036\u001f\u006b\u001c\u005d\n\u0040\u002b\u002b\u0017\u0024\u0044\u0054\u004e\u0055\u0029\u004e\u0047\"\u0004\u000e\u001b\u0007\u007f\u001a\u0075\u001b\u003e\u0042\u002d\u0015\u0025\u0055\u0035\u0006\u003d\u0072\u0042\u0015\u004d\u0016\u0019\u004a\u0049\u0025\u0047\u0019\u0070\u0076\u0066\u003a\u0031\u0029\u0014\u0056\u001f\u004c\u0024\u005f\u004a\u007b\u0068\u007e\u000e\u0024\u0005\u0013\u000b\u0073\u007b\u0078\u0074\u0000\u0040\u0042\u0039\u003d\u0061\u0000\u005d\u0045\u002b\u0040\u0029\u0020\u0059\u0063\u004a\u0070\"\u0054\u0047\u0013\f\u006d\u0011\u0012\u0018\u0011\u0019\u007f\u000e\u000f\u0043\u0037\u0000\u007f\u004e\'\\\u0041\u0002\u0007\u0061\u0074\u0002\u001d\u0073\u0024\u002e\u0062\r\u0061\u0039\u0049\u003e\u0051\u0075\u0075\u0033\u003c\u0006\u0047\u0065\u003c\u0060\u0063\u0068\u0011\t\u0055\u0048\u0025\u003d\u005e\u0006\u0046\u0001\u002a\u0038\u0060\u006f\u007e\u001d\n\u0018\u007d\u0046\u006c\r\u0043\u0042\u002b\u0026\u0008\u0005\u0061\u0019\'\u0055\u0076\u0032\u003f\u0023\u004a\u0068\u0060\"\u0056\u0059\u000e\u002b\u0060\u0019\u004f\u0052\u002e"
			+ "\t\u006c\u0048\u000b\u0031\u003b\u0057\u006b\u0049\n\u000b\u0032\u0051\u0003\\\u006b\u0050\u0036\u0033\u005e\u0039\u0003\u0011\u0042\u006d\u000b\u006e\u0028\u0068\u0004\u004f\u0004\u002c\u0056\u006f\u0014\u007e\u0059\u000f\u0050\u0043\u000b\u004f\u004c\u007a\u007c\n\u0044\u004d\r\u005f\u0007\u003e\u0052\u001f\u002c\u001c\u0077\u007a\'\u0079\u004f\u0051\u0051\u0070\u0029\u000e\u0063\u0020\u0066\u0025\u006f\u007b\u0050\u0074\u006f\u0037\u002a\u007e\u004f\u0047\u0074\u006f\u0028\t\u0037\f\n\u000f\u002f\u003b\u0078\u004c\u0046\u007c\u0014\u0066\u006d\\\u006b\u0006\u0071\u004f\u0035\u0028\u0041\u005a\u0067\u0016\r\u0064\u0076\u002e\u0050\u0077\\\u0068\u003a\u0000\u004f\t\u0024\u001b\u0047\u0066\u0000\u001f\u007a\u001d\u0054\u0072\u000f\u0049\u001a\u0021\u007e\u0068\u002d\u004c\u007b\u004f\u007e\u0079\u006d\u005b\u0076\u0039\u0020\u0048\u0073\u0061\u003d\u0048\u0055\u003d\u0023\u005d\u0044\u0065\u0078\u0042\u0045\u0037\u002d\u0012\u001e\u0072\u0047\u004d\u007d\u006c\u003b\u006b\u003a\u0066\u0073\u0049\u003a\u0067\u004c\u0008\u0056\u002f\u0018\u0001\u001b\u0045\u0017\u007a\u000b\u0046\u0012\u006b\u0021\u0005\u002d\u0053\u0071\u004d\"\u0059\u006c\u0024\u0075\u0026\u0033\u000f\u0002\u0077\u0044\u0038\u006a\t\u0010\u0046\u007b\u003c\u0049\u0023\u0067\u0003\u0028\u0037\u003e\u0032\u002f\u0076\u0063\u0028\u0006\u004d\u0031\u0000\u0060\u0023\u004a\u0076\u007e\u0047\u0052\u002d\u0077\u0031\u0062\u0070\u0070\u0079\u0014\"\u0008\u002c\u0059\u0005\u0004\u0042\u0038\u0036\u0064\u0019\u006c\u0037\u0035\u0035\u003e\u0051\u0029\u0049\u002f\u0033\u0053\u005b\u0028\u0035\u0021\u003f\u003e\u005f\u007a\u0031\u0006\'\u0013\u0007\u007e\u004e\u006f\u0010\u0005\u003f\u0043\u006f\u0040\u0043\u0018\u000f\u0007\u005f\u0061\u0040\u0003\u0030\u0013\u003a\u001f\u006c\r\r\u0076\u001c\u0007\u0076\u0007\u003a\u0016\\\u0004\u006b\u004d\u005f\u004c\u0064\r\u0004\u006b\u0019\u007c\u0003\u006a\u005b\u0046\u0061\u0000\u0020\u0061\u0067\u0040\u0002\u0079\u003e\u0077\u0050\u0015\u0077\u006b\u006f\"\\\u0024\u002a\u0051\u0048\u0029\u004d\u007d\u0030\u002e\u0030\u0053\u004b\u000f\u0024\u003f\u0065\u005d\u007e\u0068\u005e\u0047\'\u003c\u0071\u0007\u0044\u006f\u0038\u0025\u001b\u001b\u0073\u0043\u0064\u002c\u0071\u0067\u0025\u0051\u006b\u0072\u002a\u0051\u005f\u004d\u004d\u0065\u0075\u006b\u0013\u0018\u0031\u0031\u006e\u007e\t\u0004"
			+ "\u0035\u0003\u004f\u0019\n\u007e\u002b\u0062\u0023\u001b\u004b\u0018\u0071\u0002\u0068\u0057\u0038\u0023\u001a\u0055\u002c\u0047\u0012\u0002\u006f\u0013\u0017\u0010\u005d\u0033\u0043\u003b\u0041\u0001\u003a\u0001\r\u0021\u0044\u0048\u003a\u005d\u0015\u0019\u0075\u005d\u007e\u0019\u005b\u0038\u0015\u001d\u0060\u0025\u004c\u002d\u0004\u0068\u0038\u0043\u0012\u0018\u0067\u0068\u002d\u0007\u0060\u0020\u004f\u0042\u007d\f\u0025\u0026\u0034\u0002\u0028\u0075\u005d\u007e\u0008\u0006\u0057\u0013\u0068\u0074\u0017\u0025\u0052\u0037\u0074\u0018\u0037\u0048\u001e\u0028\u0034\u003c\u002d\u001d\u0065\u005f\u0035\u0003\u002b\u004e\u0020\u006f\u0075\u0007\u0045\u004e\u004d\u0053\u0079\u0057\u007a\u0049\u0020\u0011\u002f\u0000\u0034\u0070\u0034\u000f\u0075\u0020\u0001\u002d\u0038\u0040\u006f\u001b\u0020\'\u004d\u003e\u0011\u0042\u003b\\\u007f\u0006\u0020\u0070\u006c\u0004\u0060\u0019\u0043\u0028\u0003\u002d\u003e\u0001\u003b\u0068\u0051\u0040\u007a\u0061\\\u0000\u0003\u0001\u0031\u002a\u0018\u0037\u000f\u0056\u0010\u0047\u004d\u001e\u006b\u0048\u0067\u000e\u0053\r\'\u0042\u006e\u0065\u0018\u002c\u0010\u0058\u0069\u003b\u0065\u007b\u004a\u0069\u0005\u0072\u006d\u005e\u0075\u007f\u000f\u005a\u000e\u0039\u0032\u001d\u003b\u001b\u0060\u005e\u0020\u0025\u0016\u007c\u0000\u0062\u0007\u0017\u0010\u0028\u007a\u007c\u0049\u001f\u0004\u0048\u0037\r\u0064\u005f\u0039\u0013\u0033\u005b\u0048\u006b\u0002\u005b\u005a\u0034\u0073\u006b\u0047\u0073\u005a\u0054\u002a\u005e\u0001\u000f\u0065\u0016\u006b\u0058\u001e\u005f\u001a\u0034\u006d\u0034\u001f\u0044\u000f\u0014\u001d\u0075\u0075\u0045\u0043\u0066\u007c\u0028\u0050\u0051\u0026\u0065\u0058\u0051\t\u004f\r\u007d\u002e\u001f\u004e\u0056\u0070\u0053\u0058\u0043\u0031\u002a\u007f\u004e\u006e\u0071\u0059\u0003\u003e\u005e\u0034\u0032\u001a\u0024\u004c\u0038\u0010\u0049\u004e\u000e\u007d\u0023\u0048\u0006\u0000\u0003\u0040\u003a\u001c\u0073\u0046\u007d\u001f\u006b\u006b\u004f\u0055\u0070\u004e\u0073\u003a\u006b\n\u002d\r\u0057\u0016\u0006\u003c\u0079\u001f\u0023\u001b\u0050\u005a\u0038\u0011\u001d\u0001\u0019\u005e\u0026\u0077\u006d\u0028\u0046\u001d\u001d\u005f\u0043\u006e\u0031\u002e\u0058\u005a\u001c\u003f\u0031\u0060\f\u0023\u006e\u006f\f\r\u005a\u0064\u001a\f\u0041\u000b\u0032\u0037\u002c\u0037\u0066\u0051\u0059\u005d\u0034\u002b\u0052\u0015\u0032\u007d\u0072\u0028"
			+ "\u006e\u003c\u0071\u0054\u0037\u0036\u0049\u004a\u0049\u0061\u0032\n\u0030\u007f\u0063\\\u0046\u0046\u0077\u004f\u005d\u002b\u004c\u0014\u001d\u0026\u0034\t\\\u0031\u0024\u0073\u003b\u006d\u006a\u0037\u0024\u0032\u0042\u0059\u0015\u0013\u003a\u0017\u0065\u0077\f\t\u0021\u007d\u0035\u003e\u0006\u0051\u0035\u0023\u001a\u0031\u007b\u0071\u004e\u0014\u006a\r\u006e\u0011\u0030\u0011\u001c\u0015\u0061\u0006\u0024\u0017\u003d\u0054\u0051\u0070\u000e\u0055\u001c\u0079\u0034\u0014\u0048\u001e\u0001\u0043\u003a\u004d\u007a\u002d\u0024\u006c\u003f\u004a\u0015\u0028\u002e\u004c\u0045\u005e\u0058\u0050\u0026\u0051\u003e\u0034\u0073\u0051\u006b\u0042\u004b\u0054\u0065\u0030\u006e\u007a\u0055\u0045\u0069\u0063\u004b\u007d\u007d\u001f\u005d\u0025\u0077\u006d\u000f\u0060\u0046\u007b\u0025\u006f\u007a\u0005\u0016\u0030\u000e\u0025\u0024\u002b\u0007\u0058\u0021\u0040\u0019\u0058\'\u004d\u002d\u001d\u004f\\\u0059\u001f\u0026\u0021\u007d\u002d\'\u0046\u004d\u003c\\\u0059\u0070\u005b\u0076\u0020\"\\\u002d\u0023\u0016\u006a\u006b\u0007\u0020\u000b\u0076\u004c\u007d\u0068\u0073\u0067\u006d\u0033\u0071\u007a\u002d\u0014\u0007\u0073\u0072\u002e\u003e\u005b\u0072\\\u0026\u006b\u002d\u0035\u0051\u0064\u005a\u0044\u003d\u0029\u004e\u0001\u0026\u0058\u0071\u0070\u0006\u0034\u005e\u0032\u001e\u0061\u002c\u007e\u007b\u0032\u003f\u0054\u006f\u0051\u0053\u0062\u0023\u0025\u0003\u005a\u005f\u0019\u0078\u006a\u0059\u0045\u0017\u0048\u004c\\\u0028\u003c\u0017\u0060\u0019\u000f\u0035\u006a\u0060\u002a\u007d\u0072\u0060\u0072\u0013\u0047\u0053\u002f\u0023\u0002\u0050\u002b\u0037\u0029\u0008\u007a\u001b\u0037\u0020\u001d\u0005\u0042\u0025\u0002\u0059\u001e\u000b\u006e\u000f\u0057\u001e\n\u004f\u0012\u0005\u003d\n\u002e\'\r\u003b\u0015\u0013\u0050\u001c\u0054\u001b\u001f\u005b\u0033\u0031\u0073\f\u0043\u0075\u007a\u0067\f\u006f\u0059\u001b\u0039\u0073\f\u005d\u0026\u003d\u0049\"\u0062\u0055\u007e\u007d\u0020\u0035\u0031\u0052\u0005\n\u005d\u000f\u0017\u0032\u0042\u0045\u006e\u0011\u0061\u0002\u005b\u001f\u0045\u002f\u0018\u0051\u0033\u0073\u0015\u0059\u0012\u007d\u001b\u0068\u000b\u0054\'\u0003\u0006\u0072\u001c\u0037\u004e\u0056\f\u0029\u0019\u0003\u0073\u0011\u0075\u001e\u0052\f\u0017\u006c\u007c\u007b\u0067\u0014\u0024\u001c\u0073\u0011\u006e\u004f\u005f\f\u0055\u000b\u0037\r\u007d\u0043\u0014\u004f\u0028\u0064\u0046\u0079"
			+ "\u0026\u0069\u0032\u0004\u007c\u0068\u0005\n\\\u0008\u0008\u0037\u002d\u005b\u0011\u0011\u0053\u0005\u0016\u007f\u0021\u0010\u0039\u0005\u004d\u0033\u004d\u0011\u0041\u0026\"\u0017\u0001\u005d\u002c\u001b\u001b\u006c\u0078\u0070\u0041\u0048\u0057\u0016\u0077\u006f\u003e\u0074\u0036\u0058\u0046\u0050\u0019\u004d\u0010\u0005\u007e\u006b\u005a\u0038\u0077\u003d\u006d\t\u0054\u007e\u001d\u0016\u003f\u0074\u0029\u0078\u006a\n\"\u002f\u0016\u004c\u006e\u0055\u0065\u006a\u0067\u002a\u001f\u0026\u0024\u0012\u0077\r\u0033\u0004\u0055\u006b\u0079\u0071\u005e\u0047\u0069\u0026\u007c\u0046\u001a\u0050\u005e\u005d\u004f\u002b\u0058\'\u0038\u006f\u006c\u004e\u0031\\\u000e\u0040\u0070\u0036\u001b\u0067\u002d\u0044\u006a\u007f\u0043\u0048\u002c\u0071\u0057\u0054\u006f\u0055\u006a\u0001\u0001\u004b\u0004\u0013\u0056\u004e\u0016\u0030\u0069\u0052\u0023\u001a\u0040\u0011\u002d\u003e\t\u0061\u0058\u0001\u0005\t\u002c\u0060\u0074\u001d\u0003\u002e\u0013\u007b\u0026\u0039\u005d\u0020\u0024\u001b\u0067\u0073\\\u0008\u006a\u0020\u0055\u0060\u0040\u0011\u0050\u0075\u0016\'\u0039\t\u007f\u0006\u0008\u0055\u0041\u0031\u0073\u0064\u0067\u007d\u0065\u006c\u0074\u0079\u0015\u004d\u0008\u0052\u002d\u0076\u0041\u0008\u001c\u0078\u002a\u001c\u0073\u0065\u0016\u002f\u0019\u0032\u0036\u007a\u0000\u007e\u0075\u0049\u0070\u0007\u0019\u0007\u0075\u0073\u000f\u0051\u007b\u0033\u0060\u0011\u000e\u000e\u0043\u0068\u0055\u0031\u0063\u0029\u0004\u001d\u0013\u0054\'\u006f\u0033\u002d\u0006\u006b\u003d\u004b\u006a\u0042\u005b\u0023\u0040\f\u0073\u0043\u0015\u0031\u0052\u0013\u0033\u001e\u001b\u0079\u0018\u005f\u001c\u000b\t\u002d\u001f\u0077\u004f\u0016\u0036\u0074\u001f\u0056\u0076\u003a\u0079\u0035\u0023\u001f\u0079\u001f\u0032\u0045\u004e\u002f\u0072\u0072\u0011\u0030\u002b\u0066\u007e\n\u0041\u0079\u000f\u0071\u0063\u001b\u004a\u0005\u0024\u005f\u0057\u0016\u0026\u0061\u0067\u002d\u0053\u004e\u005e\n\u0050\u0064\u002c\u0044\u0057\u002a\u0046\u0046\u006d\u0041\u0003\u0057\\\u0030\u002b\u0028\u0018\u0010\u0069\u0014\f\\\u0058\u000e\u0048\u0042\u0070\u003b\r\u0060\u0070\u005a\u0031\u005b\u001d\u0053\u0013\n\u0005\u0078\u0064\u0078\u0074\u0059\u0013\u0071\u007c\u0054\u0065\u0060\u0069\u0064\u005b\u007d\u001d\u0000\u0068\u002b\u0044\\\u003e\u0021\u0070\u006c\u0014\u0074\u0020\u0052\u0074\u0033\u0024\u0033\u000b\u003e\u0038\u0048\u0018"
			+ "\u0037\u0031\u004b\u0031\u005f\u001a\u0067\u0071\u0059\\\u0064\u005e\u002e\u0073\u0002\u006d\u0074\u0038\u003f\u0047\u0071\u000e\u0079\u0029\u004d\u0052\u0050\u003d\u005a\u006c\u0024\u0039\u0066\u0013\u0067\u001f\u004d\u001f\u001f\u004d\u0071\u0030\u0062\u0062\u0066\u007e\u004b\u0003\u0050\u002c\u0012\u001f\u0052\u0062\u007d\u005f\u0032\u0014\u0067\u006a\u0023\u0079\u0055\u0074\u0063\u0013\u0058\u0047\u0013\u0054\r\u0026\u0015\u0036\u0033\u001a\u0002\u0056\u003c\u0010\u0016\u0012\u0069\u006b\u006b\u005a\u005b\u0042\u0063\u0034\u005e\u0011\u0052\u0039\u0073\u001b\u0069\u0033\n\u0025\u0001\\\u0052\u003a\u0004\u0062\u0042\u0020\u001b\u0038\u0071\u004a\u0061\'\u001b\r\u0047\u005e\u004c\u004f\u0021\u0020\u0029\u000b\u0061\u0068\u0001\u0058\u003f\u0013\u006e\u0035\u0049\u0055\u0014\u007f\u0056\u0015\u0020\u001e\u0000\u005d\u0049\u0037\u007e\u0011\u0056\u007b\u0052\u007b\u001c\"\u0026\u0048\u0016\u0064\u0004\u0001\u0008\u0056\u006c\u005e\u003d\u0079\u004d\u003b\'\u0005\u0035\u0018\u0044\u007d\u0040\u000b\u0010\u001c\u003d\u0019\u0062\u0057\u003d\u0030\t\u0028\u007a\u006f\u0042\u0074\u0038\u0010\'\u001e\u0074\u0036\u0039\u006c\u0077\u0057\u0068\u0038\u0052\u0003\u0055\u0040\u0060\u0042\u0072\u007f\u0064\u0074\u002b\u0051\r\u006c\u001e\u0055\u002f\u004d\u0041\u0019\u0079\u0055\u001f\u0043\u0014\u0046\t\u0038\u0002\u007d\u0062\u0051\u0040\u000e\r\u0055\u0064\u006b\u003a\u007c\u001f\u004c\u0043\u0029\u0078\u0034\u0069\u004b\u004d\u0075\u0000\u007e\t\u0012\u004b\u0038\u0020\u0047\u001a\u003f\u0037\'\u0018\u0026\u002c\u0073\u005f\u0044\u005b\u002b\u0063\u007b\u007e\u0019\u006b\u0006\u0072\u0073\u0000";

	// Decode the encoded Penc and Senc to set the values
	// of Pinit and Sinit.
	static {
		Pinit = new int[((Penc.length() * 7) / 32)];

		int bitsToDecode = Penc.length() * 7;
		int offset = 25;
		int i = 0;
		int j = 0;

		while (bitsToDecode > 0)
		{
			if (bitsToDecode <= 7)
			{
				Pinit[i] = ((int) Penc.charAt(j) >>> (-offset)) | Pinit[i];
			}
			else
			{
				if (offset < 0)
				{
					Pinit[i] = ((int) Penc.charAt(j) >>> (-offset)) | Pinit[i];
					i++;
					Pinit[i] =
						((int) Penc.charAt(j++) << (offset += 32)) | Pinit[i];
				}
				else
				{
					Pinit[i] = ((int) Penc.charAt(j++) << offset) | Pinit[i];
				}
			}

			offset -= 7;
			bitsToDecode -= 7;
		}

		Sinit = new int[((Senc.length() * 7) / 32)];
		bitsToDecode = Senc.length() * 7;
		offset = 25;
		i = 0;
		j = 0;

		while (bitsToDecode > 0)
		{
			if (bitsToDecode <= 7)
			{
				Sinit[i] = ((int) Senc.charAt(j) >>> (-offset)) | Sinit[i];
			}
			else
			{
				if (offset < 0)
				{
					Sinit[i] = ((int) Senc.charAt(j) >>> (-offset)) | Sinit[i];
					i++;
					Sinit[i] =
						((int) Senc.charAt(j++) << (offset += 32)) | Sinit[i];
				}
				else
				{
					Sinit[i] = ((int) Senc.charAt(j++) << offset) | Sinit[i];
				}
			}

			offset -= 7;
			bitsToDecode -= 7;
		}
	}

	//====================================
	// Useful constants
	//====================================

	private static final int ROUNDS = 16;
	private static final int BLOCK_SIZE = 8; // bytes = 64 bits
	private static final int SBOX_SK = 256;
	private static final int SBOX_KA = 4;
	private static final int P_SZ = ROUNDS + 2;

	private final int[] S0, S1, S2, S3; // the s-boxes
	private final int[] P; // the p-array

	private boolean isInit = false;
	private boolean encrypting = false;

	private byte[] workingKey = null;

	private boolean simulateKeyExpansionBug = false;

	public void simulateKeyExpansionBug()
	{
		simulateKeyExpansionBug = true;
	}

	public LegacyBlowfishEngine()
	{
		S0 = new int[SBOX_SK];
		S1 = new int[SBOX_SK];
		S2 = new int[SBOX_SK];
		S3 = new int[SBOX_SK];
		P = new int[P_SZ];
	}

	/**
	 * initialise a Blowfish cipher.
	 *
	 * @param forEncryption whether or not we are for encryption.
	 * @param params the parameters required to set up the cipher.
	 * @exception IllegalArgumentException if the params argument is
	 * inappropriate.
	 */
	public void init(boolean encrypting, CipherParameters params)
	{
		if (params instanceof KeyParameter)
		{
			this.encrypting = encrypting;
			this.workingKey = ((KeyParameter) params).getKey();
			setKey(this.workingKey);

			return;
		}

		throw new IllegalArgumentException(
			"invalid parameter passed to Blowfish init - "
				+ params.getClass().getName());
	}

	public String getAlgorithmName()
	{
		return "Blowfish";
	}

	public final int processBlock(byte[] in, int inOff, byte[] out, int outOff)
	{
		if (workingKey == null)
		{
			throw new IllegalStateException("Blowfish not initialised");
		}

		if ((inOff + BLOCK_SIZE) > in.length)
		{
			throw new DataLengthException("input buffer too short");
		}

		if ((outOff + BLOCK_SIZE) > out.length)
		{
			throw new DataLengthException("output buffer too short");
		}

		if (encrypting)
		{
			encryptBlock(in, inOff, out, outOff);
		}
		else
		{
			decryptBlock(in, inOff, out, outOff);
		}

		return BLOCK_SIZE;
	}

	public void reset()
	{
	}

	public int getBlockSize()
	{
		return BLOCK_SIZE;
	}

	//==================================
	// Private Implementation
	//==================================

	private int F(int x)
	{
		return (
			((S0[(x >>> 24)] + S1[(x >>> 16) & 0xff]) ^ S2[(x >>> 8) & 0xff])
				+ S3[x & 0xff]);
	}

	/**
	 * apply the encryption cycle to each value pair in the table.
	 */
	private void processTable(int xl, int xr, int[] table)
	{
		int size = table.length;

		for (int s = 0; s < size; s += 2)
		{
			xl ^= P[0];

			for (int i = 1; i < ROUNDS; i += 2)
			{
				xr ^= F(xl) ^ P[i];
				xl ^= F(xr) ^ P[i + 1];
			}

			xr ^= P[ROUNDS + 1];

			table[s] = xr;
			table[s + 1] = xl;

			xr = xl; // end of cycle swap
			xl = table[s];
		}
	}

	private void setKey(byte[] key)
	{

		/*
		 * - comments are from _Applied Crypto_, Schneier, p338
		 * please be careful comparing the two, AC numbers the
		 * arrays from 1, the enclosed code from 0.
		 *
		 * (1)
		 * Initialise the S-boxes and the P-array, with a fixed string
		 * This string contains the hexadecimal digits of pi (3.141...)
		 */
		System.arraycopy(Sinit, 0, S0, 0, SBOX_SK);
		System.arraycopy(Sinit, SBOX_SK, S1, 0, SBOX_SK);
		System.arraycopy(Sinit, SBOX_SK * 2, S2, 0, SBOX_SK);
		System.arraycopy(Sinit, SBOX_SK * 3, S3, 0, SBOX_SK);

		System.arraycopy(Pinit, 0, P, 0, P_SZ);

		/*
		 * (2)
		 * Now, XOR P[0] with the first 32 bits of the key, XOR P[1] with the
		 * second 32-bits of the key, and so on for all bits of the key
		 * (up to P[17]).  Repeatedly cycle through the key bits until the
		 * entire P-array has been XOR-ed with the key bits
		 */
		int keyLength = key.length;
		int keyIndex = 0;

		for (int i = 0; i < P_SZ; i++)
		{
			// get the 32 bits of the key, in 4 * 8 bit chunks
			int data = 0x0000000;
			for (int j = 0; j < 4; j++)
			{
				// create a 32 bit block
				data = (data << 8) | (key[keyIndex++] & 0xff);

				// wrap when we get to the end of the key
				if (keyIndex >= keyLength)
				{
					keyIndex = 0;
				}
			}
			// XOR the newly created 32 bit chunk onto the P-array
			P[i] ^= data;
		}

		/*
		 * (3)
		 * Encrypt the all-zero string with the Blowfish algorithm, using
		 * the subkeys described in (1) and (2)
		 *
		 * (4)
		 * Replace P1 and P2 with the output of step (3)
		 *
		 * (5)
		 * Encrypt the output of step(3) using the Blowfish algorithm,
		 * with the modified subkeys.
		 *
		 * (6)
		 * Replace P3 and P4 with the output of step (5)
		 *
		 * (7)
		 * Continue the process, replacing all elements of the P-array
		 * and then all four S-boxes in order, with the output of the
		 * continuously changing Blowfish algorithm
		 */

		processTable(0, 0, P);

		if (simulateKeyExpansionBug)
		{
			S0[0] = P[P_SZ - 2];
			S0[1] = P[P_SZ - 1];
		}

		processTable(P[P_SZ - 2], P[P_SZ - 1], S0);
		processTable(S0[SBOX_SK - 2], S0[SBOX_SK - 1], S1);
		processTable(S1[SBOX_SK - 2], S1[SBOX_SK - 1], S2);
		processTable(S2[SBOX_SK - 2], S2[SBOX_SK - 1], S3);
	}

	/**
	 * Encrypt the given input starting at the given offset and place
	 * the result in the provided buffer starting at the given offset.
	 * The input will be an exact multiple of our blocksize.
	 */
	private void encryptBlock(
		byte[] src,
		int srcIndex,
		byte[] dst,
		int dstIndex)
	{
		int xl = BytesTo32bits(src, srcIndex);
		int xr = BytesTo32bits(src, srcIndex + 4);

		xl ^= P[0];

		for (int i = 1; i < ROUNDS; i += 2)
		{
			xr ^= F(xl) ^ P[i];
			xl ^= F(xr) ^ P[i + 1];
		}

		xr ^= P[ROUNDS + 1];

		Bits32ToBytes(xr, dst, dstIndex);
		Bits32ToBytes(xl, dst, dstIndex + 4);
	}

	/**
	 * Decrypt the given input starting at the given offset and place
	 * the result in the provided buffer starting at the given offset.
	 * The input will be an exact multiple of our blocksize.
	 */
	private void decryptBlock(
		byte[] src,
		int srcIndex,
		byte[] dst,
		int dstIndex)
	{

		int xl = BytesTo32bits(src, srcIndex);
		int xr = BytesTo32bits(src, srcIndex + 4);

		xl ^= P[ROUNDS + 1];

		for (int i = ROUNDS; i > 0; i -= 2)
		{
			xr ^= F(xl) ^ P[i];
			xl ^= F(xr) ^ P[i - 1];
		}

		xr ^= P[0];

		Bits32ToBytes(xr, dst, dstIndex);
		Bits32ToBytes(xl, dst, dstIndex + 4);

	}

	private int BytesTo32bits(byte[] b, int i)
	{
		return ((b[i] & 0xff) << 24)
			| ((b[i + 1] & 0xff) << 16)
			| ((b[i + 2] & 0xff) << 8)
			| ((b[i + 3] & 0xff));
	}

	private void Bits32ToBytes(int in, byte[] b, int offset)
	{
		b[offset + 3] = (byte) in;
		b[offset + 2] = (byte) (in >> 8);
		b[offset + 1] = (byte) (in >> 16);
		b[offset] = (byte) (in >> 24);
	}
}
